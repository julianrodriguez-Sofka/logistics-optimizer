name: CI Pipeline - Logistics Shipping Optimizer

on:
  push:
    branches:
      - main
      - Feature/refactor
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

# Permisos expl√≠citos para GitHub Actions
permissions:
  contents: read
  pull-requests: read
  checks: write

# Evitar ejecuciones duplicadas
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22.x'

jobs:
  # ============================================================================
  # BACKEND JOB
  # ============================================================================
  backend:
    name: üîß Backend - Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: ./logistics-back

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üü¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ./logistics-back/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci --no-audit

      - name: üî® Build TypeScript
        run: npm run build

      - name: üß™ Run tests with coverage
        id: backend-tests
        run: |
          npm run test:coverage 2>&1 | tee test-output.txt || true
          
          # Extract coverage from output
          if [ -f coverage/coverage-summary.json ]; then
            LINE_COV=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct // 0')
            echo "line_coverage=$LINE_COV" >> $GITHUB_OUTPUT
            echo "‚úÖ Coverage: ${LINE_COV}%"
          else
            echo "‚ö†Ô∏è No coverage summary found"
            mkdir -p coverage
            echo "TN:" > coverage/lcov.info
          fi

      - name: üìä Coverage Report
        run: |
          echo "=========================================="
          echo "üìä BACKEND COVERAGE REPORT"
          echo "=========================================="
          
          if [ -f coverage/coverage-summary.json ]; then
            jq -r '
              "Lines:      \(.total.lines.pct)%",
              "Branches:   \(.total.branches.pct)%",
              "Functions:  \(.total.functions.pct)%",
              "Statements: \(.total.statements.pct)%"
            ' coverage/coverage-summary.json
          else
            echo "‚ö†Ô∏è No coverage summary found"
          fi
          
          echo "=========================================="

      - name: üì§ Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: |
            logistics-back/coverage/lcov.info
            logistics-back/coverage/coverage-summary.json
          retention-days: 1
          if-no-files-found: warn

  # ============================================================================
  # FRONTEND JOB
  # ============================================================================
  frontend:
    name: üé® Frontend - Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: ./logistics-front

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üü¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ./logistics-front/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci --no-audit

      - name: üîç Run ESLint
        continue-on-error: true
        run: npm run lint || echo "‚ö†Ô∏è ESLint found some issues"

      - name: üî® Build Vite production bundle
        run: npm run build

      - name: üß™ Run tests with coverage
        continue-on-error: true
        run: |
          npm test -- --run --coverage 2>&1 | tee test-output.txt || true
          
          # Check if coverage was generated
          if [ -f coverage/coverage-summary.json ]; then
            LINE_COV=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct // 0')
            echo "‚úÖ Coverage: ${LINE_COV}%"
          else
            echo "‚ö†Ô∏è No coverage summary found"
            mkdir -p coverage
            echo "TN:" > coverage/lcov.info
          fi

      - name: üìä Coverage Report
        run: |
          echo "=========================================="
          echo "üìä FRONTEND COVERAGE REPORT"
          echo "=========================================="
          
          if [ -f coverage/coverage-summary.json ]; then
            jq -r '
              "Lines:      \(.total.lines.pct)%",
              "Branches:   \(.total.branches.pct)%",
              "Functions:  \(.total.functions.pct)%",
              "Statements: \(.total.statements.pct)%"
            ' coverage/coverage-summary.json
          else
            echo "‚ö†Ô∏è No coverage summary found"
          fi
          
          echo "=========================================="

      - name: üì§ Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: |
            logistics-front/coverage/lcov.info
            logistics-front/coverage/coverage-summary.json
          retention-days: 1
          if-no-files-found: warn

  # ============================================================================
  # SONARCLOUD JOB
  # ============================================================================
  sonarcloud:
    name: üîç SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    # Always run SonarCloud, even if previous jobs failed
    if: always()
    timeout-minutes: 10

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì• Download backend coverage
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: backend-coverage
          path: logistics-back/coverage

      - name: üì• Download frontend coverage
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: frontend-coverage
          path: logistics-front/coverage

      - name: üìÅ Prepare coverage files
        run: |
          echo "=========================================="
          echo "üìÅ COVERAGE FILES STATUS"
          echo "=========================================="
          
          # Ensure directories exist
          mkdir -p logistics-back/coverage
          mkdir -p logistics-front/coverage
          
          # Backend
          if [ -f logistics-back/coverage/lcov.info ]; then
            BACKEND_SIZE=$(wc -l < logistics-back/coverage/lcov.info)
            echo "‚úÖ Backend lcov.info: $BACKEND_SIZE lines"
          else
            echo "‚ö†Ô∏è Backend lcov.info: Creating empty file"
            echo "TN:" > logistics-back/coverage/lcov.info
          fi
          
          # Frontend
          if [ -f logistics-front/coverage/lcov.info ]; then
            FRONTEND_SIZE=$(wc -l < logistics-front/coverage/lcov.info)
            echo "‚úÖ Frontend lcov.info: $FRONTEND_SIZE lines"
          else
            echo "‚ö†Ô∏è Frontend lcov.info: Creating empty file"
            echo "TN:" > logistics-front/coverage/lcov.info
          fi
          
          echo "=========================================="

      - name: üîç Verify SonarCloud configuration
        run: |
          echo "=========================================="
          echo "üîç SONARCLOUD CONFIGURATION"
          echo "=========================================="
          
          if [ -f sonar-project.properties ]; then
            echo "‚úÖ sonar-project.properties found"
            echo ""
            echo "Project Key: $(grep 'sonar.projectKey' sonar-project.properties | cut -d'=' -f2)"
            echo "Organization: $(grep 'sonar.organization' sonar-project.properties | cut -d'=' -f2)"
          else
            echo "‚ùå sonar-project.properties NOT found"
          fi
          
          echo "=========================================="
          echo ""
          echo "SONAR_TOKEN configured: ${{ secrets.SONAR_TOKEN != '' }}"

      - name: üîç SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ============================================================================
  # PIPELINE SUMMARY
  # ============================================================================
  pipeline-summary:
    name: üìã Pipeline Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend, sonarcloud]
    if: always()

    steps:
      - name: üìã Generate Summary
        run: |
          echo "# üìã CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Backend status
          BACKEND="${{ needs.backend.result }}"
          if [ "$BACKEND" == "success" ]; then
            echo "| üîß Backend | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$BACKEND" == "skipped" ]; then
            echo "| üîß Backend | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üîß Backend | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Frontend status
          FRONTEND="${{ needs.frontend.result }}"
          if [ "$FRONTEND" == "success" ]; then
            echo "| üé® Frontend | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$FRONTEND" == "skipped" ]; then
            echo "| üé® Frontend | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üé® Frontend | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # SonarCloud status
          SONAR="${{ needs.sonarcloud.result }}"
          if [ "$SONAR" == "success" ]; then
            echo "| üîç SonarCloud | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$SONAR" == "skipped" ]; then
            echo "| üîç SonarCloud | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üîç SonarCloud | ‚ö†Ô∏è Issues |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

      - name: ‚úÖ Final Status
        run: |
          echo "=========================================="
          echo "üìã FINAL PIPELINE STATUS"
          echo "=========================================="
          echo "Backend:    ${{ needs.backend.result }}"
          echo "Frontend:   ${{ needs.frontend.result }}"
          echo "SonarCloud: ${{ needs.sonarcloud.result }}"
          echo "=========================================="
          
          # Pipeline passes if both backend and frontend succeed
          if [ "${{ needs.backend.result }}" == "success" ] && [ "${{ needs.frontend.result }}" == "success" ]; then
            echo "‚úÖ Pipeline PASSED"
          else
            echo "‚ö†Ô∏è Pipeline has issues - check logs"
          fi
