name: CI Pipeline - Logistics Shipping Optimizer

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  backend:
    name: Backend - Build & Test
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./logistics-back

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Para SonarQube

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ“¦ Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ./logistics-back/node_modules
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-backend-${{ hashFiles('logistics-back/package-lock.json', 'logistics-back/package.json') }}    
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-backend-
            ${{ runner.os }}-node-${{ matrix.node-version }}-

      - name: ğŸ“¦ Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: ğŸ”¨ Build TypeScript
        run: npm run build

      - name: ğŸ§ª Run unit tests with coverage
        run: npm run test:coverage || npm test -- --coverage

      - name: ğŸ“Š Upload coverage to Codecov (Optional)
        continue-on-error: true
        uses: codecov/codecov-action@v4
        with:
          files: ./logistics-back/coverage/lcov.info
          flags: backend
          name: backend-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: ğŸ“ˆ Check coverage threshold (70%+)
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq bc
          
          echo "Looking for coverage files..."
          ls -la coverage/
          
          # Check for coverage-summary.json first (Jest generates this)
          if [ -f coverage/coverage-summary.json ]; then
            echo "âœ… Found coverage-summary.json"
            COVERAGE=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
            echo "Backend Coverage: ${COVERAGE}%"
            
            if (( $(echo "$COVERAGE < 70" | bc -l) )); then
              echo "âŒ Backend coverage is below 70%: ${COVERAGE}%"
              exit 1
            else
              echo "âœ… Backend coverage meets threshold: ${COVERAGE}%"
            fi
          else
            echo "âŒ No coverage-summary.json found"
            exit 1
          fi

      - name: ğŸ“¤ Upload backend coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: logistics-back/coverage/
          retention-days: 1

  frontend:
    name: Frontend - Build & Test
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./logistics-front

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Para SonarQube

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ“¦ Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ./logistics-front/node_modules
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-frontend-${{ hashFiles('logistics-front/package-lock.json', 'logistics-front/package.json') }} 
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-frontend-
            ${{ runner.os }}-node-${{ matrix.node-version }}-

      - name: ğŸ“¦ Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: ğŸ” Run ESLint
        run: npm run lint

      - name: ğŸ”¨ Build Vite production bundle
        run: npm run build

      - name: ğŸ§ª Run unit tests with coverage
        run: npm test -- --run --coverage --reporter=verbose

      - name: ğŸ“Š Upload coverage to Codecov (Optional)
        continue-on-error: true
        uses: codecov/codecov-action@v4
        with:
          files: ./logistics-front/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: ğŸ“ˆ Check coverage threshold (70%+)
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq bc
          
          echo "Looking for coverage files..."
          ls -la coverage/
          
          # Check for coverage-summary.json (Vitest can generate this with json-summary reporter)
          if [ -f coverage/coverage-summary.json ]; then
            echo "âœ… Found coverage-summary.json"
            COVERAGE=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
            echo "Frontend Coverage: ${COVERAGE}%"
            
            if (( $(echo "$COVERAGE < 70" | bc -l) )); then
              echo "âŒ Frontend coverage is below 70%: ${COVERAGE}%"
              exit 1
            else
              echo "âœ… Frontend coverage meets threshold: ${COVERAGE}%"
            fi
          else
            echo "âŒ No coverage-summary.json found"
            echo "Please update vitest.config.ts to include 'json-summary' in coverage reporters"
            exit 1
          fi

      - name: ğŸ“¤ Upload frontend coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: logistics-front/coverage/
          retention-days: 1

  sonarqube:
    name: ğŸ” SonarQube Analysis
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: success()

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para SonarQube

      - name: ğŸ“¥ Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: logistics-back/coverage

      - name: ğŸ“¥ Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: logistics-front/coverage

      - name: ğŸ“Š Verify coverage files
        run: |
          echo "Backend coverage files:"
          ls -la logistics-back/coverage/
          echo "Frontend coverage files:"
          ls -la logistics-front/coverage/

      - name: ğŸ” SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: âœ… SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  ci-success:
    name: âœ… CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [backend, frontend, sonarqube]
    if: success()

    steps:
      - name: ğŸ‰ All checks passed
        run: |
          echo "âœ… Backend: Build & Tests passed"
          echo "âœ… Frontend: Build & Tests passed"
          echo "âœ… Backend: Coverage >= 70%"
          echo "âœ… Frontend: Coverage >= 70%"
          echo "âœ… SonarQube: Quality Gate passed"
          echo "ğŸš€ Ready for deployment"

  ci-failure:
    name: âŒ CI Pipeline Failed
    runs-on: ubuntu-latest
    needs: [backend, frontend, sonarqube]
    if: failure()

    steps:
      - name: ğŸ’¥ Pipeline failed
        run: |
          echo "âŒ One or more jobs failed"
          echo "ğŸ“ Check logs above for details"
          exit 1